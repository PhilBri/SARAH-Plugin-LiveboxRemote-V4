var lbData;
function sendLiveBox (data, cfgLiveBox, sendClbk) {
    lbData = data;
    var ipCmd = require('ipCmd')[data.cmd],
        cmdTab = [];
    
    if (ipCmd) {
        ipCmd = ipCmd.split(',');
        while (ipCmd.length) {
            var s = ipCmd.shift().split(':');
            cmdTab.push('operation=01&key=' + s.shift() +'&mode=' + s);
        };
    }
    else if (data.hasOwnProperty('epg'))
        cmdTab.push('operation=09&epg_id=' + "*".repeat(10 - (data.epg.length)) + data.epg + '&uui=1');

    cmdTab.push('operation=10');
    sendData(cmdTab, cfgLiveBox, sendClbk);
}

function sendData (cmdTab, cfgLiveBox, clbk) {
    var options = { url: 'http://' + cfgLiveBox.IP + ':8080/remoteControl/cmd?' + cmdTab.shift() };

    require('request')(options, function (err, response, body) {
        if ( !err && response.statusCode == 200 ) {
            body = JSON.parse(body);
            body = body.result.data.activeStandbyState || body.result.detail;
            if (body) body == 'STB not ready' ? clbk(1) : clbk(body);
            if (cmdTab.length) {
                var lbTimer = lbData.stby == 1 ? 2300 : 150;
                if (cmdTab.length == 1) setTimeout( function() { sendData (cmdTab, cfgLiveBox, clbk) }, lbTimer);
                else setTimeout( function() { sendData (cmdTab, cfgLiveBox, clbk) }, 150);
            }
        }
        else error('[ LiveboxRemote ] ' + err);
    });
}
module.exports = sendLiveBox;
